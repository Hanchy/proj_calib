#pragma once

#include <algorithm>
#include <opencv2/opencv.hpp>

template <typename T>
class SpacePoints {
 public:
  explicit SpacePoints();

  // bool insert(int _label, cv::Point3f &_pt);
  bool insert(const int _label, const T &_pt);
  bool remove(const int _label);

  bool get_labeled_pt(const int _label, T &_pt);

  T *get_labeled_pt_pointer(const int _label);

  void clear();
  int size();
  
  

  std::vector<T> points_;
  std::map<int, int> l2pt_idx_;

 private:
  int tail_idx_;
};


template <typename T>
SpacePoints<T>::SpacePoints() : tail_idx_(0) {
}


template <typename T>
bool SpacePoints<T>::insert(const int _label, const T &_pt) {
  auto search = l2pt_idx_.find(_label);
  if (search != l2pt_idx_.end()) { // already exists, rewrite it
    points_[search->second] = _pt;
    return false;
  } else {
    points_.push_back(_pt);
    l2pt_idx_.insert(std::make_pair(_label, tail_idx_));
    tail_idx_++;
  }
  return true;
}


template <typename T>
bool SpacePoints<T>::remove(const int _label) {
  auto search = l2pt_idx_.find(_label);
  if (search == l2pt_idx_.end())
    return false;

  auto pIt = points_.begin() + search->second;
  points_.erase(pIt);
  l2pt_idx_.erase(search);
  tail_idx_--;

  for (auto & e :l2pt_idx_) {
    if (e.second > search->second)
      e.second--;
  }

  return true;
}


template <typename T>
bool SpacePoints<T>::get_labeled_pt(const int _label, T &_pt) {
  auto search = l2pt_idx_.find(_label);
  if (search == l2pt_idx_.end()) // not found
    return false;

  _pt = points_[search->second];
  return true;
}


template <typename T>
T *SpacePoints<T>::get_labeled_pt_pointer(const int _label) {
  auto search = l2pt_idx_.find(_label);
  if (search == l2pt_idx_.end()) // not found
    return nullptr;

  return &(points_[search->second]);
}


template <typename T>
void SpacePoints<T>::clear() {
  points_.clear();
  l2pt_idx_.clear();
  tail_idx_ = 0;
}

template <typename T>
int SpacePoints<T>::size() {
  return tail_idx_;
}
